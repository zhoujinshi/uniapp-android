"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var fs=_interopDefault(require("fs")),path=_interopDefault(require("path")),glob=_interopDefault(require("glob")),child_process=require("child_process"),fs$1=_interopDefault(require("fs-extra")),merge=_interopDefault(require("merge")),esprima=_interopDefault(require("esprima")),sourceMap=require("source-map"),babel=_interopDefault(require("babel-core")),async=require("async"),async__default=_interopDefault(async),stripJsonComments=_interopDefault(require("strip-json-comments"));const chalk=require("chalk"),isWin=/^win/.test(process.platform),normalizePath=e=>isWin?e.replace(/\\/g,"/"):e,wccRelativePath=isWin?"./package.nw/js/vendor/wcc.exe":"./Contents/Resources/app.nw/js/vendor/wcc",wccOldMacRelativePath="./Contents/Resources/package.nw/js/vendor/wcc",wcscRelativePath=isWin?"./package.nw/js/vendor/wcsc.exe":"./Contents/Resources/app.nw/js/vendor/wcsc",wcscOldMacRelativePath="./Contents/Resources/package.nw/js/vendor/wcsc",wxDevToolsAppDataWindowsPath=process.env.APPDATA&&path.resolve(process.env.APPDATA,"./Tencent/微信web开发者工具/")||__dirname,wxDevToolsDirs=[];isWin&&wxDevToolsDirs.push([path.resolve(wxDevToolsAppDataWindowsPath,wccRelativePath),path.resolve(wxDevToolsAppDataWindowsPath,wcscRelativePath)]),wxDevToolsDirs.push([path.resolve(process.env.WX_DEVTOOLS||__dirname,wccRelativePath),path.resolve(process.env.WX_DEVTOOLS||__dirname,wcscRelativePath)]),wxDevToolsDirs.push([path.resolve(process.env.WX_DEVTOOLS||__dirname,wccOldMacRelativePath),path.resolve(process.env.WX_DEVTOOLS||__dirname,wcscOldMacRelativePath)]),isWin||(wxDevToolsDirs.push([path.resolve("/Applications/微信开发者工具.app/",wccRelativePath),path.resolve("/Applications/微信开发者工具.app/",wcscRelativePath)]),wxDevToolsDirs.push([path.resolve("/Applications/微信开发者工具.app/",wccOldMacRelativePath),path.resolve("/Applications/微信开发者工具.app/",wcscOldMacRelativePath)]),wxDevToolsDirs.push([path.resolve("/Applications/wechatwebdevtools.app/",wccRelativePath),path.resolve("/Applications/wechatwebdevtools.app/",wcscRelativePath)]),wxDevToolsDirs.push([path.resolve("/Applications/wechatwebdevtools.app/",wccOldMacRelativePath),path.resolve("/Applications/wechatwebdevtools.app/",wcscOldMacRelativePath)]));const getWcsc=()=>{for(let e=0;e<wxDevToolsDirs.length;e++){const n=wxDevToolsDirs[e];if(fs.existsSync(n[1]))return n[1]}throw new Error("\n1.检查升级最新版本微信开发者工具\t\t\n2.检查微信开发者工具配置目录是否正确（菜单运行-运行到小程序模拟器-运行设置）\n3.重新安装最新版本微信开发者工具\n\t")},getWcc=()=>{for(let e=0;e<wxDevToolsDirs.length;e++){const n=wxDevToolsDirs[e];if(fs.existsSync(n[0]))return n[0]}throw new Error("\n1.检查升级最新版本微信开发者工具\t\t\n2.检查微信开发者工具配置目录是否正确（菜单运行-运行到小程序模拟器-运行设置）\n3.重新安装最新版本微信开发者工具\n\t")},textColor=e=>{switch(e.toLowerCase()){case"success":return"green";case"info":return"blue";case"note":return"white";case"warning":return"yellow";case"error":default:return"red"}},log=(e,n,t)=>{"error"===e?console.error(chalk[textColor(e)]("["+n+"]",t)):console.log(chalk[textColor(e)]("["+n+"]",t))},success=(e,n)=>{log("success",e,n)},error=(e,n)=>{log("error",e,n)};function parseWxss(e,n){const t=glob.sync("**/*.wxss",{nodir:!0,cwd:e,ignore:["./node_modules/**/*"]}).map(e=>"./"+e),o=[],a=child_process.spawn(getWcsc(),["-js","-pc",t.length].concat(t),{cwd:e});a.stdout.on("data",e=>{o.push(e)}),a.stderr.on("data",e=>{error("错误",e)}),a.on("close",e=>{const t=Buffer.concat(o).toString().split("="),a={},s=t.length;for(let e=0;e<s&&t[e+1];e+=2)a[t[e]]=new Function("{return `"+t[e+1]+"`}")();n(null,a)})}var debug=!1,appname="",entryPagePath="",page={},global={window:{navigationBarBackgroundColor:"#000000",navigationBarTextStyle:"white",navigationBarTitleText:"",navigationStyle:"default",backgroundColor:"#ffffff",backgroundColorTop:"#ffffff",backgroundColorBottom:"#ffffff",enablePullDownRefresh:!1,onReachBottomDistance:50}},tabBar={color:"",selectedColor:"",backgroundColor:"",borderStyle:"black",list:[],position:"bottom"},networkTimeout={request:6e4,connectSocket:6e4,uploadFile:6e4,downloadFile:6e4},platform="",defaultConfig={debug:debug,appname:appname,entryPagePath:entryPagePath,page:page,global:global,tabBar:tabBar,networkTimeout:networkTimeout,platform:platform};function parseConfig(e){let n=!1;try{n=JSON.parse(fs$1.readFileSync(path.join(e,"./app.json"))),(n=merge.recursive(!0,defaultConfig,n)).platform="devtools",n.entryPagePath=n.pages.length&&n.pages[0]+".html"||"",n.global.window=n.window||{},delete n.window,n.tabBar&&n.tabBar.list.length&&n.tabBar.list.forEach(n=>{if(n.pagePath=n.pagePath+".html",n.iconPath){if(!fs$1.existsSync(path.join(e,n.iconPath)))throw new Error(`pages.json->tabBar->list->iconPath->[${n.iconPath}] 不存在，图片资源必须存放在项目根目录下的 static 目录`);if(n.iconData=new Buffer(fs$1.readFileSync(path.join(e,n.iconPath))).toString("base64"),delete n.iconPath,!fs$1.existsSync(path.join(e,n.selectedIconPath)))throw new Error(`pages.json->tabBar->list->selectedIconPath->[${n.selectedIconPath}] 不存在，图片资源必须存放在项目根目录下的 static 目录`);n.selectedIconData=new Buffer(fs$1.readFileSync(path.join(e,n.selectedIconPath))).toString("base64"),delete n.selectedIconPath}}),fs$1.existsSync(path.join(e,"./__uniappsecondary.js"))?(n.secondary=n.secondary||100,n.global.window.navigationStyle="custom"):delete n.secondary}catch(e){console.error(e),n=!1}return n}function parseResource(e,n){const t=[],o=[],a={},s=[],r=[],i=[],c=[],p=glob.sync("**/*.wxs",{nodir:!0,cwd:n,ignore:["./node_modules/**/*"]}).map(e=>"./"+e),l=glob.sync("**/*.wxml",{nodir:!0,cwd:n,ignore:["./node_modules/**/*"]}).map(e=>"./"+e).concat(p);glob.sync("**/*.json",{nodir:!0,cwd:n,ignore:["./node_modules/**/*"]}).map(e=>{if("manifest.json"!==e){const t=require(path.join(n,e));(t.usingComponents||t.componentGenerics||!0===t.component)&&(a[e]=t,!0===t.component&&i.push(e.replace(".json",".js")))}});const u=glob.sync("**/*.js",{nodir:!0,cwd:n,ignore:["./node_modules/**/*"]}),d=e.pages.map(function(e){return e+".js"});return u.forEach(e=>{-1===d.indexOf(e)&&-1===i.indexOf(e)&&"app.js"!==e&&r.push(e)}),d.forEach(e=>{if(-1===u.indexOf(e))console.log(` ✗ ${e} not found`);else{s.push(e),e=e.replace(".js",""),t.push(e+".html");const a=path.join(n,e+".json");fs$1.existsSync(a)?c.push({name:e+".html",json:a}):c.push({name:e+".html"}),o.push(e+".wxss")}}),e.page={},c.forEach(function(n){if(e.page[n.name]={window:{}},n.json){const t=fs$1.readFileSync(n.json,"utf-8");try{e.page[n.name].window=JSON.parse(t)}catch(e){}}}),{wxjs:{page:s,module:r,component:i},page:t,wxml:l,wxss:o,componentJsons:a}}const ignoreFiles=["manifest.json","app-service.js","app-view.js","setCssToHead.js","__uniappview.css","__uniappview.js","__uniappservice.html","__uniappview.html"];function copyTemplate(e){fs$1.copySync(path.join(__dirname,"../template"),e,{filter:e=>!~ignoreFiles.indexOf(path.basename(e))})}const whiteFileExtName=[".png",".jpg",".jpeg",".gif",".svg",".cer",".mp3",".aac",".m4a",".mp4",".wav",".ogg",".silk",".map",".ttf"];function copyResource(e,n){glob.sync("./**",{nodir:!0,cwd:e,ignore:["./node_modules/**/*"]}).forEach(t=>{(~whiteFileExtName.indexOf(path.extname(t).toLowerCase())||~t.indexOf("__uniappsecondary.js"))&&fs$1.copySync(path.join(e,t),path.join(n,t))})}const getCompileConfig=function(e,n,t,o){let a=0,s=[];return Object.keys(t).forEach(e=>{const n=t[e];if(n.usingComponents||n.componentGenerics){s.push("./"+e.replace(".json",".wxml"));const t=Object.assign({},n.usingComponents,n.componentGenerics);s.push(Object.keys(t).length),s=s.concat(Object.keys(t)),a++}}),s.unshift(a),["-d","-"+e,s.join(" ")].concat(o)},generateWxml=function(e,n,t,o,a){if(!o.length)return void a("");const s=[],r=getCompileConfig(e,0,t,o),i=child_process.spawn(getWcc(),r,{cwd:path.join(n,"./")});i.stdout.on("data",e=>{s.push(e)}),i.stderr.on("data",e=>{error("错误",e)}),i.on("close",e=>{a(null,Buffer.concat(s).toString())})};class GenerateSourceMap{constructor(e="main"){this.name=e,this.generator=new sourceMap.SourceMapGenerator({file:e})}addSourceMap({map:e,sourceContent:n},t=0,o="uniapp:///"){new sourceMap.SourceMapConsumer(e).eachMapping(e=>{e.originalLine&&this.generator.addMapping({name:e.name,source:o+e.source,original:{line:e.originalLine,column:e.originalColumn},generated:{line:e.generatedLine+t,column:e.generatedColumn}})}),this.generator.setSourceContent(o+e.sources[0],n)}addFile(e,n,t,o="uniapp:///"){const a=esprima.tokenizer(n,{locations:!0});for(;;){const n=a.getToken();if("eof"===n.type.label)break;const s={original:n.loc.start,generated:{line:n.loc.start.line+t,column:n.loc.start.column},source:o+e};"name"===n.type.label&&(s.name=n.value),this.generator.addMapping(s)}this.generator.setSourceContent(o+e,n)}toString(){return this.generator.toString()}toSourceMapUrl(e="inline"){return"inline"===e?"//# sourceMappingURL=data:application/json;charset=utf-8;base64,"+new Buffer(this.toString()).toString("base64"):"//# sourceMappingURL="+this.name+".map"}}const varCode="var __wxAppData = {};\nvar __wxRoute;\nvar __wxRouteBegin;\nvar __wxAppCode__ = {};\nvar global = {};\nvar __wxAppCurrentFile__;\nvar Component = Component || function() {};\nvar definePlugin = definePlugin || function() {};\nvar requirePlugin = requirePlugin || function() {};\nvar Behavior = Behavior || function() {};\nvar $gwx;\n",paramsCode="require, module, exports, window, document, frames, self, location, navigator, localStorage, history, Caches, screen, alert, confirm, prompt, fetch, XMLHttpRequest, WebSocket, webkit, WeixinJSCore, Reporter, print, WeixinJSBridge",getLines=function(e){return e.split(/[\r\n]/).length},defineJsCode=(e,n,t)=>(t.sourceMap&&(t.start+=1,t.sourceMap.addSourceMap(n,t.start),t.start+=getLines(n.code)+1),`\ndefine('${e}',function(${paramsCode}){\n${n.code}\n});`),defineAppCode=(e,n,t)=>{const o=`${defineJsCode(e,n,t)}\nrequire('${e}');`;return t.start+=1,o},defineComponentCode=(e,n,t,o)=>definePageCode(e,n,t,o),definePageCode=(e,n,t,o)=>{o.start+=2;const a=`\n__wxRoute = '${e}';__wxRouteBegin = true;__wxAppCurrentFile__ = '${n}';\n${defineJsCode(n,t,o)}\nrequire('${n}');`;return o.start+=1,a},loadBabelModule=function(e){try{const n=require.resolve(e);return n.slice(0,n.lastIndexOf(e)+e.length)}catch(n){return e}},createTransformFileSync=function(e,n){return function(t,o){const a=fs$1.readFileSync(path.join(e,t),"utf-8");if(n||o){const e=babel.transform(a,{sourceMaps:n,sourceFileName:n&&t,presets:[loadBabelModule("babel-preset-env")],plugins:[["babel-plugin-transform-class-properties"],["babel-plugin-transform-object-rest-spread"]],minified:!1,comments:!1});return{code:e.code,map:e.map,sourceContent:a}}return{code:a,map:{},sourceContent:a}}},wxAppCode=function(e){return Object.keys(e).map(n=>`\n__wxAppCode__['${n}']=${JSON.stringify(e[n])};\n__wxAppCode__['${n.replace(".json",".wxml")}']=$gwx('./${n.replace(".json",".wxml")}');\n`).join("")};function generateServiceJs(e,n,t,o,a,s,r){generateWxml("xc",n,t,o,function(o,i){o&&console.error(o);let c="";c=Object.keys(t).length?`${varCode}  \n${i}\n${wxAppCode(t)}\n`:`${varCode} \n      `;const p={start:getLines(c),sourceMap:s&&new GenerateSourceMap("app-service.js")},l=createTransformFileSync(n,s);p.start+=1;const u=a.module.map(e=>~["common/manifest.js","common/vendor.js"].indexOf(e)?defineJsCode(e,l(e),p):defineJsCode(e,l(e,!0),p)).join("");p.start+=1;const d=defineAppCode("app.js",l("app.js"),p);p.start+=1;const f=a.component.map(e=>defineComponentCode(e.replace(".js",""),e,l(e,!0),p)).join("");p.start+=1;const g=[{path:"app-service.js",content:`${c}\n${u}\n${d}\n${f}\n${a.page.map(e=>definePageCode(e.replace(".js",""),e,l(e),p)).concat(e.nvue&&Object.keys(e.nvue.pages).map(e=>definePageCode(e.replace(".html",""),e.replace(".html",".js"),{code:"\n    Page({\n            onShow: function() {}\n        })\n    "},p))||[]).join("")}\n${p.sourceMap&&p.sourceMap.toSourceMapUrl()||""}\n`}];r&&r(g)})}function generateServiceHtml(e,n){const t=fs$1.readFileSync(path.join(__dirname,"../template/__uniappservice.html"),"utf-8");e.nvue&&(e.nvue.entryPagePath&&(e.entryPagePath=e.nvue.entryPagePath),e.pages=e.pages.concat(Object.keys(e.nvue.pages).map(e=>e.replace(".html",""))));const o=`var __wxConfig = ${JSON.stringify(e)}`;n("__uniappservice.html",t.replace("/*CONFIG*/",function(){return o}).replace("\x3c!--TOPTABBAR--\x3e",function(){return e.secondary?'<div id="app"></div>\n<script type="text/javascript" src="__uniappsecondary.js"><\/script>':""}))}const beforeCode="var __pageFrameStartTime__ = Date.now();\nvar __webviewId__;\nvar __wxAppCode__ = {};\nvar __WXML_GLOBAL__ = {\n  entrys: {},\n  defines: {},\n  modules: {},\n  ops: [],\n  wxs_nf_init: undefined,\n  total_ops: 0\n};\nvar $gwx;\n",afterCode=";var __pageFrameEndTime__ = Date.now();\nif(!window.__uniAppViewReady__){\n\twindow.__uniAppViewReady__ = true;\n\tdocument.dispatchEvent(new CustomEvent('uniAppViewReady'));\n}\n",wxAppCode$1=function(e,n){return Object.keys(e).map(e=>{const t="./"+e.replace(".json",".wxml"),o="./"+e.replace(".json",".wxss");return`\n__wxAppCode__['${e.replace(".json",".wxss")}']=${n[o]};    \n__wxAppCode__['${e.replace(".json",".wxml")}']=$gwx('${t}');\n`}).join("")};function generateViewJs(e,n,t,o,a){const s=[];s.push(function(n){generateWxml("cc",e,t,o,n)}),async__default.parallel(s,function(e,o){e&&console.error(e);const s=o[0]||"",r=n.comm;a&&a("app-view.js",`${beforeCode}\n${s}\n${r}\n${wxAppCode$1(t,n)}\n${afterCode}\n`)})}function generateServiceHtml$1(e,n){const t=fs$1.readFileSync(path.join(__dirname,"../template/__uniappview.html"),"utf-8");e.nvue&&(e.nvue.entryPagePath&&(e.entryPagePath=e.nvue.entryPagePath),e.pages=e.pages.concat(Object.keys(e.nvue.pages).map(e=>e.replace(".html",""))));const o=`var __wxConfig = ${JSON.stringify(e)}`;n("__uniappview.html",t.replace("/*CONFIG*/",function(){return o}))}function generatePageCssJs(e,n,t){t&&t(n.map(n=>{const t=e["./"+n],o="./"+n.replace(".wxss",".wxml"),a=(t&&t+"();\n"||"")+`document.dispatchEvent(new CustomEvent("generateFuncReady", { detail: { generateFunc: $gwx('${o}') } }));`;return{path:n.replace(".wxss",".js"),content:`\n      !(function(){\n        var uniAppViewReadyCallback = function(){\n          ${a}\n        }\n        if(window.__uniAppViewReady__){\n          uniAppViewReadyCallback()\n        }else{\n          document.addEventListener('uniAppViewReady',uniAppViewReadyCallback)\n        }\n      })();\n      `}}))}function manifest(e,n,t,o){const a=n.global.window,s=a.navigationBarBackgroundColor||"#000000",r=a.navigationBarTextStyle||"white",i=require(path.join(__dirname,"../template/manifest.json"));i.plus.statusbar={immersed:"supportedDevice",style:"black"===r?"dark":"light",background:s};let c=!1;if(fs$1.existsSync(path.resolve(e,"./manifest.json"))&&(c=JSON.parse(stripJsonComments(fs$1.readFileSync(path.resolve(e,"./manifest.json"),"utf8")))),!c)throw new Error("manifest.json 不存在");let p=i;if(c){(p=merge.recursive(!0,i,{id:c.appid||"",name:c.name||"",description:c.description||"",version:{name:c.versionName,code:c.versionCode}},{plus:c["app-plus"]})).plus.modules&&(p.permissions=p.plus.modules,delete p.plus.modules);const e=p.plus.distribute;e&&(e.android&&(p.plus.distribute.google=e.android,delete p.plus.distribute.android),e.ios&&(p.plus.distribute.apple=e.ios,delete p.plus.distribute.ios),e.sdkConfigs&&(p.plus.distribute.plugins=e.sdkConfigs,delete p.plus.distribute.sdkConfigs)),p.permissions&&p.permissions.Maps&&(p.permissions.Maps.coordType="gcj02"),p.permissions||(p.permissions={}),n.nvue&&(p.permissions.UniNView={description:"UniNView原生渲染"})}if(t&&t.condition&&Array.isArray(t.condition.list)&&t.condition.list.length){const e=t.condition.list;let n=parseInt(t.condition.current)||0;n<0&&(n=0),n>=e.length&&(n=0),p.plus.arguments=JSON.stringify(e[n])}p.plus.allowsInlineMediaPlayback=!0,n.tabBar&&n.tabBar.list&&n.tabBar.list.length&&(p.plus.safearea||(p.plus.safearea={background:n.tabBar.backgroundColor||"#FFFFFF",bottom:{offset:"auto"}})),p.plus.splashscreen&&p.plus.splashscreen.delay&&(n.splashscreen={delay:p.plus.splashscreen.delay}),n.appname=c.name,p.plus.distribute||(p.plus.distribute={plugins:{}}),p.plus.distribute.plugins||(p.plus.distribute.plugins={}),p.plus.distribute.plugins.audio={mp3:{description:"Android平台录音支持MP3格式文件"}},o&&o("manifest.json",JSON.stringify(p))}function index(e,n,t,o,a){const s=normalizePath(path.resolve(e,"./")),r=normalizePath(path.resolve(n,t||"HBuilderProject"));a=a||{};const i=parseConfig(s);if(!i)return error("ERROR","读取app.json失败..."),void(o&&o(!1));const{wxjs:c,wxml:p,wxss:l,componentJsons:u}=parseResource(i,s);parseWxss(s,function(e,n){if(e)throw new Error(e);const t=[],d=function(e){return function(n,t){Array.isArray(n)?e(null,n):e(null,[{path:n,content:t}])}};t.push(function(e){manifest(s,i,a,d(e))}),t.push(function(e){generateServiceHtml(i,d(e))}),t.push(function(e){generateServiceJs(i,s,u,p,c,!1,d(e))}),t.push(function(e){generateServiceHtml$1(i,d(e))}),t.push(function(e){generateViewJs(s,n,u,p,d(e))}),t.push(function(e){generatePageCssJs(n,l,d(e))}),async.parallel(t,function(e,n){e&&console.error(e),n.forEach(function(e){e.forEach(function(e){fs$1.outputFileSync(path.join(r,e.path),e.content,{override:!0})})}),copyResource(s,r),copyTemplate(r),success("完成","uni-app 编译完毕"),console.log("***DONE***"),o&&o(!0)})})}module.exports=index;
